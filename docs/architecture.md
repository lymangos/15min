# 15分钟生活圈 - 架构设计文档

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (Web)                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Leaflet Map   │  │  Result Panel   │  │   Chart/Stats   │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │           │
│           └────────────────────┼────────────────────┘           │
│                                │ HTTP/JSON                      │
└────────────────────────────────┼────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Backend (Go + Gin)                         │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                      API Layer                              ││
│  │  POST /api/v1/isochrone    POST /api/v1/analyze             ││
│  │  GET /api/v1/poi/categories GET /api/v1/evaluation/standards││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Service Layer                            ││
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐     ││
│  │  │IsochroneService│ │  POIService  │ │EvaluationService│    ││
│  │  └───────────────┘ └───────────────┘ └───────────────┘     ││
│  └─────────────────────────────────────────────────────────────┘│
│                                │                                │
└────────────────────────────────┼────────────────────────────────┘
                                 │ SQL
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│              Database (PostgreSQL + PostGIS + pgRouting)        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Spatial Functions                        ││
│  │  calculate_isochrone()  query_pois_in_isochrone()          ││
│  │  evaluate_life_circle() find_nearest_node()                ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                       Tables                                ││
│  │  ┌─────────┐ ┌─────────────────┐ ┌─────────┐ ┌───────────┐ ││
│  │  │  ways   │ │ways_vertices_pgr│ │   poi   │ │poi_category││
│  │  └─────────┘ └─────────────────┘ └─────────┘ └───────────┘ ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

## 核心算法

### 等时圈计算流程

```
1. 接收用户点击坐标 (lng, lat)
         │
         ▼
2. find_nearest_node() 
   查找最近的路网节点
         │
         ▼
3. pgr_drivingDistance()
   计算从该节点出发，在给定时间内可达的所有节点
   cost = length_m / (walk_speed * 1000 / 60)
         │
         ▼
4. ST_ConcaveHull() / ST_ConvexHull()
   将可达节点集合生成多边形
         │
         ▼
5. 返回 GeoJSON 格式的等时圈
```

### 评分计算逻辑

```
总分 = Σ (分类得分 × 分类权重)

分类得分 = Σ (子类型得分) / Σ (子类型满分)

子类型得分 = 
  if 实际数量 >= 要求数量:
    满分
  else:
    满分 × (实际数量 / 要求数量)

评级:
  A: 90-100  优秀
  B: 75-89   良好
  C: 60-74   一般
  D: 45-59   较差
  E: 0-44    差
```

## 坐标系处理

| 场景 | SRID | 说明 |
|------|------|------|
| 数据存储 | 4326 (WGS84) | 经纬度坐标，与 OSM 数据一致 |
| 距离计算 | geography | 使用 `::geography` 类型转换 |
| 面积计算 | 投影坐标系 | 使用 ST_Transform 转为本地投影 |
| 前端显示 | 4326 | Leaflet 默认使用 WGS84 |

### 距离计算示例

```sql
-- 使用 geography 类型计算真实距离（米）
SELECT ST_Distance(
    geom_a::geography,
    geom_b::geography
) AS distance_meters;

-- 或使用投影坐标系（适用于小范围）
SELECT ST_Distance(
    ST_Transform(geom_a, 3857),
    ST_Transform(geom_b, 3857)
) AS distance_meters;
```

## 数据流

```
OSM 数据
    │
    ├─── osm2pgrouting ──→ ways, ways_vertices_pgr (路网)
    │
    └─── osm2pgsql ──→ planet_osm_* ──→ poi (兴趣点)

用户请求
    │
    ▼
API (Gin) ──→ Service ──→ Database
    │                         │
    │                         ▼
    │              空间函数 (pgRouting + PostGIS)
    │                         │
    │                         ▼
    │              等时圈 + POI 查询 + 评分
    │                         │
    └──────── GeoJSON ◄───────┘
                  │
                  ▼
            Frontend 渲染
```
